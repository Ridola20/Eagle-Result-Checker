<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - Student Passwords</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.12.0/cdn.min.js" defer></script>
    <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
    <style>
        .form-input { border: 2px solid #e5e7eb; transition: all 0.2s ease; }
        .form-input:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.08); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div class="container mx-auto p-6">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">Admin - Student Passwords</h1>
            <div class="flex items-center gap-2">
                <input id="searchInput" placeholder="Search by name or exam number" class="form-input px-3 py-2 rounded"/>
                <button id="searchBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Search</button>
                <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded">Logout</button>
            </div>
        </div>

        <div id="alert" class="hidden mb-4 p-3 rounded bg-yellow-100 text-yellow-800"></div>

        <div id="tableWrap" class="bg-white shadow rounded overflow-x-auto">
            <table class="min-w-full text-left">
                <thead class="bg-gray-100 text-sm text-gray-700">
                    <tr>
                        <th class="px-4 py-3">#</th>
                        <th class="px-4 py-3">Student Name</th>
                        <th class="px-4 py-3">Exam Number</th>
                        <th class="px-4 py-3">Access Key</th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="text-sm text-gray-800"></tbody>
            </table>
        </div>

        <div id="pagination" class="mt-4 flex items-center gap-2"></div>
    </div>

    <script>
        const pageSize = 50;
        let currentPage = 1;
        let lastPage = 1;

        function showAlert(message, isError=false) {
            const el = document.getElementById('alert');
            el.textContent = message;
            el.classList.remove('hidden');
            el.classList.toggle('bg-red-100', isError);
            setTimeout(()=>el.classList.add('hidden'), 5000);
        }

        async function authenticate() {
            const pass = prompt('Please enter admin passkey to view student passwords:');
            if (!pass) return showAlert('Authentication cancelled', true);

            try {
                const resp = await fetch('/admin/passwords/auth', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({passkey: pass})
                });

                if (resp.status === 200) {
                    const data = await resp.json();
                    if (data.success) {
                        currentPage = 1;
                        fetchData();
                        return;
                    }
                }

                const err = await resp.json();
                showAlert(err.error || 'Authentication failed', true);
                setTimeout(()=>authenticate(), 400);
            } catch (e) {
                showAlert('Auth request failed', true);
            }
        }

        async function fetchData(page = 1, q = '') {
            currentPage = page;
            try {
                const url = `/admin/passwords/data?page=${page}&q=${encodeURIComponent(q)}`;
                const resp = await fetch(url, {cache: 'no-store'});
                if (resp.status === 403) {
                    showAlert('Unauthorized. Session expired or invalid passkey.', true);
                    setTimeout(()=>authenticate(), 400);
                    return;
                }
                const data = await resp.json();
                renderTable(data.data);
                renderPagination(data.total, data.page, data.page_size);
            } catch (e) {
                showAlert('Failed to fetch data', true);
            }
        }

        function renderTable(rows) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            if (!rows || rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-3">No records found.</td></tr>';
                return;
            }
            rows.forEach((r, idx) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-4 py-3">${r.id}</td>
                    <td class="px-4 py-3">${escapeHtml(r.student_name)}</td>
                    <td class="px-4 py-3">${escapeHtml(r.exam_number)}</td>
                    <td class="px-4 py-3 font-mono">${escapeHtml(r.access_key)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderPagination(total, page, pageSize) {
            lastPage = Math.max(1, Math.ceil(total / pageSize));
            currentPage = page;
            const wrap = document.getElementById('pagination');
            wrap.innerHTML = '';
            const prev = document.createElement('button');
            prev.textContent = 'Prev'; prev.className = 'px-3 py-1 bg-gray-100 rounded';
            prev.disabled = (page <= 1);
            prev.onclick = () => fetchData(page - 1, document.getElementById('searchInput').value.trim());
            wrap.appendChild(prev);

            const span = document.createElement('span');
            span.className = 'px-3';
            span.textContent = `Page ${page} of ${lastPage}`;
            wrap.appendChild(span);

            const next = document.createElement('button');
            next.textContent = 'Next'; next.className = 'px-3 py-1 bg-gray-100 rounded';
            next.disabled = (page >= lastPage);
            next.onclick = () => fetchData(page + 1, document.getElementById('searchInput').value.trim());
            wrap.appendChild(next);
        }

        // Simple HTML escape
        function escapeHtml(s) { return (s === null || s === undefined) ? '' : String(s).replace(/[&<>'"]/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;' }[c] || c)); }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('searchBtn').addEventListener('click', () => {
                fetchData(1, document.getElementById('searchInput').value.trim());
            });
            document.getElementById('searchInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); fetchData(1, document.getElementById('searchInput').value.trim()); }
            });
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await fetch('/admin/passwords/logout', { method: 'POST' });
                showAlert('Logged out. Re-auth required');
                setTimeout(()=>authenticate(), 200);
            });
            // Start authentication flow
            authenticate();
        });
    </script>
</body>
</html>
